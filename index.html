<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>نماز به افق مشهد</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#1e293b; --muted:#94a3b8; --text:#e2e8f0;
      --brand:#93c5fd; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#334155;
      --ring:#60a5fa;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui, Tahoma; background:var(--bg); color:var(--text); }
    a{ color:var(--brand); text-decoration:none; }
    .container{ max-width:980px; margin:0 auto; padding:24px; }
    header{ display:flex; flex-direction:column; gap:12px; margin-bottom:16px; }
    nav{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    nav a{ padding:8px 10px; border-radius:10px; background:var(--chip); color:var(--text); transition:transform .12s ease, background .2s ease; }
    nav a:hover{ transform:translateY(-1px); background:#3a4a63; }
    h1{ margin:0; font-size:22px; }
    h2{ margin:12px 0 16px; font-size:20px; }
    .toolbar{ display:flex; flex-wrap:wrap; align-items:center; justify-content:center; margin-bottom:16px; gap:6px; }
    .btn{ background:#334155; color:var(--text); border:none; padding:6px 10px; border-radius:10px; cursor:pointer; font-size:14px; transition:transform .12s ease, background .2s ease, opacity .2s; }
    .btn:hover{ transform:translateY(-1px); background:#3a4a63; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn.primary{ background:var(--ok); color:#0b141e; }
    .grid{ display:grid; gap:12px; }
    /* پیش‌فرض دسکتاپ: کارت‌های روز مثل قبل */
    .days{ grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); }
    .card{ background:var(--panel); border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.25); border:1px solid rgba(148,163,184,.08); }
    .day-card{ display:block; color:var(--text); position:relative; }
    .day-card:hover{ transform:translateY(-1px); }
    .day-card.today{ outline:2px solid var(--ring); box-shadow:0 0 0 4px rgba(96,165,250,.15), 0 6px 18px rgba(0,0,0,.28); }
    .day-title{ font-weight:800; margin-bottom:6px; }
    .muted{ color:var(--muted); font-size:13px; }
    .rows{ display:grid; gap:10px; }
    .row{
      display:grid;
      grid-template-columns: 1fr auto auto 1.4fr; /* نام | زمان اذان | دکمه | وضعیت */
      gap:10px; align-items:center; padding:10px 12px;
      background:rgba(255,255,255,.02); border:1px solid rgba(148,163,184,.08); border-radius:12px;
    }
    .num{ font-variant-numeric: tabular-nums; letter-spacing:.2px; }
    .chip{ background:var(--chip); border-radius:999px; padding:4px 10px; font-size:12px; }
    .stat-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:8px; margin-bottom:16px; }
    .stat .label{ color:var(--muted); font-size:13px; margin-bottom:6px; }
    .stat .value{ font-size:22px; font-weight:800; }
    .inline{ display:inline-flex; gap:8px; align-items:center; }
    .flex{ display:flex; }
    .gap8{ gap:8px; } .gap12{ gap:12px; }
    .hidden{ display:none; } .hr{ height:1px; background:#233044; margin:12px 0; }
    .danger{ color:var(--bad); } .success{ color:#22c55e; } .warn{ color:var(--warn); }
    .center{ text-align:center; } .wrap{ white-space: pre-wrap; }
    canvas{ background:transparent; }

    /* کارت‌های گزارش هر نماز + نمودار دایره‌ای */
    .prayer-report{
      display:grid; grid-template-columns: auto 160px; align-items:center; gap:12px;
    }
    .prayer-report .chips{ display:flex; flex-wrap:wrap; gap:8px; }

    /* موبایل: روزها در دو ردیف با اسکرول افقی */
    @media (max-width: 480px) {
      .container { padding: 12px; }
      h1 { font-size: 18px; }
      h2 { font-size: 16px; margin: 8px 0 12px; }
      .card { padding: 10px; border-radius:12px; }
      .stat .value { font-size: 18px; }
      .inline { flex-wrap: wrap; }
      .btn { font-size: 13px; padding: 5px 8px; }
      .days{
        display:grid;
        grid-auto-flow: column;
        grid-template-rows: repeat(2, minmax(84px, auto));
        grid-auto-columns: minmax(220px, 1fr);
        gap:10px;
        overflow-x:auto; padding-bottom:6px;
        scroll-snap-type: x proximity;
      }
      .day-card{ scroll-snap-align:start; }
      .prayer-report{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>تاریخ‌ها</h1>
      <nav>
        <a href="#" id="nav-days">روزها</a>
        <a href="#" id="nav-report">گزارش ۷ روزه</a>
      </nav>
    </header>

    <!-- ====== صفحه روزها ====== -->
    <section id="view-days">
      <div class="toolbar">
        <button class="btn" id="btn-prev-month">ماه قبل</button>
        <div class="inline">
          <div class="chip" id="current-month-label">—</div>
          <button class="btn" id="btn-today">امروز</button>
        </div>
        <button class="btn" id="btn-next-month">ماه بعد</button>
      </div>
      <div class="grid days" id="days-grid"></div>

      <div class="hr"></div>

      <div id="day-panel" class="hidden">
        <h2 id="day-title">—</h2>
        <div class="grid rows" id="prayers-rows"></div>
        <div class="muted" id="sunrise-line" style="margin-top:10px;"></div>
        <div class="muted" style="margin-top:10px;">روش محاسبه: Tehran (17.7, 4.5, 14) – افق مشهد – Asia/Tehran</div>
      </div>
    </section>

    <!-- ====== صفحه گزارش ====== -->
    <section id="view-report" class="hidden">
      <h2>گزارش ۷ روز اخیر</h2>

      <div class="stat-grid">
        <div class="card stat">
          <div class="label">تعداد ثبت‌ها</div>
          <div class="value" id="stat-total">0</div>
        </div>
        <div class="card stat">
          <div class="label">اول‌وقت (≤ ۱۵ دقیقه)</div>
          <div class="value success" id="stat-ontime">0</div>
        </div>
        <div class="card stat">
          <div class="label">میانگین تاخیر (دقیقه)</div>
          <div class="value danger" id="stat-avg">0</div>
        </div>
      </div>

      <!-- نمودار میله‌ای حذف شد؛ نمودارهای دایره‌ای برای هر نماز در by-prayer تولید می‌شوند. -->
      <div class="grid" id="by-prayer"></div>
      <div class="muted" style="margin-top:10px;">تعاریف: اول‌وقت ≤ ۱۵ دقیقه، مطلوب ≤ ۶۰ دقیقه، دیر &lt; ۴ ساعت، خیلی دیر ≥ ۴ ساعت</div>

      <div class="hr"></div>
      <div class="inline gap12">
        <button class="btn danger" id="btn-clear-logs">حذف همه ثبت‌ها</button>
        <span class="muted">این فقط اطلاعات ذخیره‌شده در مرورگر شما را پاک می‌کند.</span>
      </div>
    </section>
  </div>

  <script>
    // =============================
    // تنظیمات اصلی
    // =============================
    const TEHRAN_OFFSET_MIN = 210; // +03:30
    const TEHRAN_OFFSET_MS = TEHRAN_OFFSET_MIN * 60 * 1000;

    // مختصات مشهد
    const COORDS = { lat: 36.2605, lon: 59.6168 };

    // API اوقات شرعی
    const ADHAN_ENDPOINT = "https://api.aladhan.com/v1/timings";

    // لیست نمازهای موردنیاز
    const PRAYER_MAP = [
      { key: "Fajr",   label: "صبح" },
      { key: "Dhuhr",  label: "ظهر" },
      { key: "Maghrib",label: "مغرب" }
    ];

    // آستانه‌های وضعیت
    const ONTIME_THRESHOLD_MIN = 15; // اول‌وقت ≤ 15
    const GOOD_THRESHOLD = 60;       // مطلوب ≤ 60
    const LATE_RED_THRESHOLD = 240;  // خیلی دیر ≥ 240 (4h)

    // =============================
    // کمک‌تابع‌ها
    // =============================
    const faDigits = "۰۱۲۳۴۵۶۷۸۹";
    function faToEn(str){ return String(str).replace(/[۰-۹]/g, d => String(faDigits.indexOf(d))); }
    function pad(n){ return String(n).padStart(2,"0"); }

    const fmtPersianFull  = new Intl.DateTimeFormat("fa-IR-u-ca-persian",{year:"numeric",month:"long",day:"numeric"});
    const fmtPersianParts = new Intl.DateTimeFormat("fa-IR-u-ca-persian",{year:"numeric",month:"numeric",day:"numeric"});
    const fmtPersianMonth = new Intl.DateTimeFormat("fa-IR-u-ca-persian",{year:"numeric",month:"long"});

    function persianParts(date){
      const parts = fmtPersianParts.formatToParts(date);
      const m = {};
      for (const p of parts){
        if (p.type==="year")  m.jy = parseInt(faToEn(p.value),10);
        if (p.type==="month") m.jm = parseInt(faToEn(p.value),10);
        if (p.type==="day")   m.jd = parseInt(faToEn(p.value),10);
      }
      return m;
    }

    // --- تقویم جلالی ↔ میلادی
    function div(a,b){ return Math.trunc(a/b); }
    function g2d(gy,gm,gd){ const a=div(14-gm,12), y=gy+4800-a, m=gm+12*a-3; return gd+div(153*m+2,5)+365*y+div(y,4)-div(y,100)+div(y,400)-32045; }
    function d2g(jdn){ let j=jdn+32044; let g=div(4*j+3,146097); j=j-div(146097*g,4); let y=div(4*j+3,1461); j=j-div(1461*y,4); let m=div(5*j+2,153); const gd=j-div(153*m+2,5)+1; const gm=m+3-12*div(m,10); const gy=100*g+y-4800+div(m,10); return [gy,gm,gd]; }
    function jalCal(jy){ const breaks=[-61,9,38,199,426,686,913,1172,1410,1635,1900,2048,2097,2192,2262,2324,2394,2456,2501,2557,2619,2706,2755,2816,2878,2942,2991,3047,3108,3170,3225,3280,3342,3404,3469,3531,3594,3656,3711,3771,3833,3895,3950,4008,4072];
      let bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm,jump,leap,n,i;
      for(i=1;i<bl;i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; leapJ=leapJ+div(jump,33)*8+div((jump%33),4); jp=jm; }
      n=jy-jp; leapJ=leapJ+div(n,33)*8+div((n%33+3),4); if(((jump%33)===1)&&(jump-n===4)) leapJ+=1;
      let leapG=div(gy,4)-div((div(gy,100)+1)*3,4)-150; let march=20+leapJ-leapG;
      if((jump-n)<6) n=n-jump+div(jump+4,33)*33; leap=((((n+1)%33)-1)%4); if(leap===-1) leap=4;
      return { gy, march, leap: leap===0 };
    }
    function j2d(jy,jm,jd){ const r=jalCal(jy); return g2d(r.gy,3,r.march)+(jm-1)*31-div(jm,7)*(jm-7)+jd-1; }
    function d2j(jdn){ let gy,gm,gd; [gy,gm,gd]=d2g(jdn); let jy=gy-621; const r=jalCal(jy); const jdn1f=g2d(gy,3,r.march); let jd,jm,k; k=jdn-jdn1f;
      if(k>=0){ if(k<=185){ jm=1+div(k,31); jd=(k%31)+1; return [jy,jm,jd]; } else { k-=186; } }
      else { jy-=1; k+=179; if(r.leap) k+=1; }
      jm=7+div(k,30); jd=(k%30)+1; return [jy,jm,jd];
    }
    function jalaliToGregorian(jy,jm,jd){ return d2g(j2d(jy,jm,jd)); }
    function gregorianToJalali(gy,gm,gd){ return d2j(g2d(gy,gm,gd)); }

    // =============================
    // اوقات شرعی + کش
    // =============================
    const CACHE_KEY = "adhan_cache_v2";
    function loadCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||"{}"); }catch{ return {}; } }
    function saveCache(obj){ localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }

    async function getTimingsForGregorian(gy,gm,gd){
      const key = `${gy}-${pad(gm)}-${pad(gd)}`;
      const cache = loadCache();
      if (cache[key]) return cache[key];

      const url =
        `${ADHAN_ENDPOINT}/${pad(gd)}-${pad(gm)}-${gy}` +
        `?latitude=${COORDS.lat}&longitude=${COORDS.lon}` +
        `&method=99&methodSettings=17.7,4.5,14` +   // Tehran angles
        `&school=0&timezonestring=Asia/Tehran` +
        `&latitudeAdjustmentMethod=3` +
        `&tune=0,0,0,0,0,0,0,0,0`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("API error");
      const json = await res.json();
      const t = json.data.timings;
      const keep = { Fajr:t.Fajr, Sunrise:t.Sunrise, Dhuhr:t.Dhuhr, Asr:t.Asr, Maghrib:t.Maghrib, Isha:t.Isha };
      const out = { gy,gm,gd, timings: keep };
      cache[key] = out; saveCache(cache);
      return out;
    }

    // تبدیل ساعت محلی تهران ("HH:MM") به Date (UTC)
    function tehranLocalToUTCDate(gy,gm,gd,hhmm){
      const [hh,mm] = hhmm.split(":").map(v=>parseInt(v,10));
      const utcMs = Date.UTC(gy,gm-1,gd,hh,mm) - TEHRAN_OFFSET_MS;
      return new Date(utcMs);
    }

    // =============================
    // ذخیره‌سازی ثبت‌ها
    // =============================
    const LOGS_KEY = "namaz_logs_v2";
    function loadLogs(){ try{ return JSON.parse(localStorage.getItem(LOGS_KEY)||"[]"); }catch{ return []; } }
    function saveLogs(arr){ localStorage.setItem(LOGS_KEY, JSON.stringify(arr)); }
    function logKey(jy,jm,jd,prayer){ return `${jy}-${jm}-${jd}-${prayer}`; }
    function getLog(jy,jm,jd,prayer){ return loadLogs().find(x=>x.id===logKey(jy,jm,jd,prayer)); }
    function addOrUpdateLog(rec){
      const all = loadLogs();
      const i = all.findIndex(x=>x.id===rec.id);
      if (i>=0) all[i] = rec; else all.push(rec);
      saveLogs(all); return rec;
    }

    // =============================
    // ناوبری ویوها
    // =============================
    const viewDays   = document.getElementById("view-days");
    const viewReport = document.getElementById("view-report");
    document.getElementById("nav-days").addEventListener("click", e=>{ e.preventDefault(); showView("days"); });
    document.getElementById("nav-report").addEventListener("click", e=>{ e.preventDefault(); showView("report"); refreshReport(); });
    function showView(name){
      if (name==="days"){ viewDays.classList.remove("hidden"); viewReport.classList.add("hidden"); }
      else { viewReport.classList.remove("hidden"); viewDays.classList.add("hidden"); }
    }

    // =============================
    // وضعیت ماه جاری (شمسی)
    // =============================
    let currentJ = (()=>{ const p = persianParts(new Date()); return { jy:p.jy, jm:p.jm }; })();
    const daysGrid = document.getElementById("days-grid");
    const currentMonthLabel = document.getElementById("current-month-label");
    const btnPrev = document.getElementById("btn-prev-month");
    const btnNext = document.getElementById("btn-next-month");
    const btnToday= document.getElementById("btn-today");

    btnPrev.addEventListener("click", ()=>{ currentJ.jm--; if(currentJ.jm<1){ currentJ.jm=12; currentJ.jy--; } renderMonth(); });
    btnNext.addEventListener("click", ()=>{ currentJ.jm++; if(currentJ.jm>12){ currentJ.jm=1; currentJ.jy++; } renderMonth(); });
    btnToday.addEventListener("click", ()=>{ const p=persianParts(new Date()); currentJ={jy:p.jy, jm:p.jm}; renderMonth(); });

    function buildJalaliMonth(jy,jm){
      const [gy,gm,gd] = jalaliToGregorian(jy,jm,1);
      let d = new Date(Date.UTC(gy,gm-1,gd,12,0,0));
      const days = [];
      while(true){
        const p = persianParts(d);
        if (p.jy!==jy || p.jm!==jm) break;
        days.push({ jy, jm, jd:p.jd, date:new Date(d) });
        d = new Date(d.getTime()+86400000);
        if (days.length>32) break;
      }
      return { jy, jm, label: fmtPersianMonth.format(new Date(Date.UTC(gy,gm-1,gd))), days };
    }
    function fmtPersianDayLabel(date){ return fmtPersianFull.format(date); }

    function renderMonth(){
      const m = buildJalaliMonth(currentJ.jy, currentJ.jm);
      const todayJ = persianParts(new Date());
      currentMonthLabel.textContent = m.label;
      daysGrid.innerHTML = "";
      m.days.forEach(d=>{
        const a = document.createElement("a");
        a.href="#"; a.className="card day-card";
        if (d.jy===todayJ.jy && d.jm===todayJ.jm && d.jd===todayJ.jd){
          a.classList.add("today");
        }
        a.innerHTML = `<div class="day-title">${fmtPersianDayLabel(d.date)}</div><div class="muted">مشاهده اوقات و ثبت نماز</div>`;
        a.addEventListener("click", e=>{ e.preventDefault(); openDay(d); });
        daysGrid.appendChild(a);
      });
    }

    // =============================
    // پنل روز و ردیف‌ها
    // =============================
    const dayPanel    = document.getElementById("day-panel");
    const dayTitle    = document.getElementById("day-title");
    const prayersRows = document.getElementById("prayers-rows");
    const sunriseLine = document.getElementById("sunrise-line");

    async function openDay(d){
      const { jy, jm, jd } = d;
      const [gy,gm,gd] = jalaliToGregorian(jy,jm,jd);
      dayTitle.textContent = `${fmtPersianFull.format(new Date(Date.UTC(gy,gm-1,gd)))} – به افق مشهد`;
      dayPanel.classList.remove("hidden");
      prayersRows.innerHTML = `<div class="muted">در حال دریافت اوقات شرعی...</div>`;
      try{
        const { timings } = await getTimingsForGregorian(gy,gm,gd);
        prayersRows.innerHTML = "";
        PRAYER_MAP.forEach(({key,label})=>{
          const t = timings[key]; // "HH:MM"
          const adhanUTC = tehranLocalToUTCDate(gy,gm,gd,t);
          const row = buildPrayerRow({ jy, jm, jd, label, adhanLocal:t, adhanUTC, gy, gm, gd });
          prayersRows.appendChild(row);
        });
        sunriseLine.textContent = `طلوع خورشید: ${timings.Sunrise}`;
      }catch(e){
        prayersRows.innerHTML = `<div class="danger">خطا در دریافت اوقات شرعی. لطفاً دوباره تلاش کنید.</div>`;
      }
      dayPanel.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    function buildPrayerRow({ jy, jm, jd, label, adhanLocal, adhanUTC, gy, gm, gd }) {
      const div = document.createElement("div"); div.className="row";
      const id  = logKey(jy,jm,jd,label);
      const log = getLog(jy,jm,jd,label);

      const status = document.createElement("div");
      status.style.textAlign = "start";
      status.innerHTML = log ? fmtStatus(log.delayMin) : `<span class="muted">—</span>`;

      const timeEl = document.createElement("div");
      timeEl.className = "num";
      timeEl.textContent = adhanLocal;

      const btn = document.createElement("button");
      btn.className="btn primary"; btn.textContent="الان خوندم";

      // قفل تاریخ‌های غیرامروز
      const today = new Date(); today.setHours(0,0,0,0);
      const prayerDate = new Date(gy,gm-1,gd); prayerDate.setHours(0,0,0,0);

      // پیش‌فرض دکمه: فقط امروز و بدون ثبت قبلی
      if (prayerDate > today){ btn.disabled=true; btn.textContent="برای آینده"; }
      else if (prayerDate < today){ btn.disabled=true; btn.textContent="گذشته"; }
      else if (log){ btn.disabled=true; btn.textContent="ثبت شد"; }

      // جلوگیری از ثبت قبل از اذان (برای امروز)
      const nowUTC = new Date();
      if (!btn.disabled && prayerDate.getTime()===today.getTime() && nowUTC < adhanUTC){
        btn.disabled = true; btn.textContent = "هنوز نرسیده";
        const ms = adhanUTC.getTime() - nowUTC.getTime();
        setTimeout(()=>{
          const l = getLog(jy,jm,jd,label);
          if (!l){ btn.disabled=false; btn.textContent="الان خوندم"; }
        }, Math.max(ms, 0));
      }

      btn.addEventListener("click", ()=>{
        if (btn.disabled) return;
        const now = new Date();
        const diffMin = Math.round((now.getTime() - adhanUTC.getTime())/60000);
        const rec = {
          id, jy, jm, jd, prayer: label,
          adhanUTC: adhanUTC.toISOString(),
          prayedUTC: now.toISOString(),
          delayMin: diffMin
        };
        addOrUpdateLog(rec);
        status.innerHTML = fmtStatus(diffMin);
        btn.disabled = true; btn.textContent = "ثبت شد";
        refreshReport();
      });

      const nameEl = document.createElement("div");
      nameEl.style.fontWeight = "800";
      nameEl.textContent = label;

      div.appendChild(nameEl);
      div.appendChild(timeEl);
      div.appendChild(btn);
      div.appendChild(status);
      return div;
    }

    // وضعیت رنگی تاخیر
    function fmtStatus(delayMin){
      const abs = Math.abs(delayMin);
      if (delayMin < 0) return `<span class="danger num">${abs} دقیقه قبل از اذان</span>`;
      if (delayMin <= ONTIME_THRESHOLD_MIN){
        return `<span class="success num">${delayMin} دقیقه - اول وقت</span>`;
      }
      if (delayMin <= GOOD_THRESHOLD){
        return `<span class="warn num">${delayMin} دقیقه - مطلوب</span>`;
      }
      if (delayMin < LATE_RED_THRESHOLD){
        return `<span style="color:orange" class="num">${delayMin} دقیقه - دیر</span>`;
      }
      return `<span class="danger num">${delayMin} دقیقه - خیلی دیر</span>`;
    }

    // =============================
    // گزارش ۷ روزه + نمودارهای دایره‌ای
    // =============================
    const statTotal = document.getElementById("stat-total");
    const statOntime= document.getElementById("stat-ontime");
    const statAvg   = document.getElementById("stat-avg");
    const byPrayer  = document.getElementById("by-prayer");
    const btnClear  = document.getElementById("btn-clear-logs");

    let pieCharts = [];

    btnClear.addEventListener("click", ()=>{
      if (confirm("همه ثبت‌ها پاک شوند؟")){
        localStorage.removeItem(LOGS_KEY);
        refreshReport();
      }
    });

    function bucketsFor(arr){
      const onTime = arr.filter(x=>x.delayMin>=0 && x.delayMin<=ONTIME_THRESHOLD_MIN).length;
      const good   = arr.filter(x=>x.delayMin>ONTIME_THRESHOLD_MIN && x.delayMin<=GOOD_THRESHOLD).length;
      const late   = arr.filter(x=>x.delayMin>GOOD_THRESHOLD && x.delayMin<LATE_RED_THRESHOLD).length;
      const vlate  = arr.filter(x=>x.delayMin>=LATE_RED_THRESHOLD).length;
      return { onTime, good, late, vlate };
    }

    function refreshReport(){
      // تخریب چارت‌های قبلی
      pieCharts.forEach(ch => ch.destroy());
      pieCharts = [];

      const logs = loadLogs();
      const now = Date.now();
      const sevenDaysMs = 6*86400000; // امروز و 6 روز قبل
      const start = now - sevenDaysMs;
      const recent = logs.filter(x=>{
        const t = Date.parse(x.prayedUTC);
        return t >= start && t <= now;
      });

      const total = recent.length;
      const ontime = recent.filter(x => x.delayMin >= 0 && x.delayMin <= ONTIME_THRESHOLD_MIN).length;
      const positiveDelays = recent.filter(x=>x.delayMin>0).map(x=>x.delayMin);
      const avgDelay = positiveDelays.length ? Math.round(positiveDelays.reduce((s,v)=>s+v,0)/positiveDelays.length) : 0;

      statTotal.textContent = total;
      statOntime.textContent = ontime;
      statAvg.textContent    = avgDelay;

      // کارت‌ها + نمودارهای دایره‌ای برای هر نماز
      const labels = ["صبح","ظهر","مغرب"];
      byPrayer.innerHTML = "";
      labels.forEach(n=>{
        const arr = recent.filter(x=>x.prayer===n);
        const cnt = arr.length;
        const { onTime, good, late, vlate } = bucketsFor(arr);

        const card = document.createElement("div");
        card.className = "card prayer-report";

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="flex gap12" style="align-items:center; justify-content:space-between;">
            <div style="font-weight:800">${n}</div>
          </div>
          <div class="chips" style="margin-top:10px;">
            <span class="chip">تعداد: <span class="num">${cnt}</span></span>
            <span class="chip">اول‌وقت: <span class="success num">${onTime}</span></span>
            <span class="chip">مطلوب: <span class="warn num">${good}</span></span>
            <span class="chip">دیر: <span class="num" style="color:orange">${late}</span></span>
            <span class="chip">خیلی دیر: <span class="danger num">${vlate}</span></span>
          </div>
        `;

        const right = document.createElement("div");
        right.className = "center";
        const canvas = document.createElement("canvas");
        canvas.width = 160; canvas.height = 160;
        right.appendChild(canvas);

        card.appendChild(left);
        card.appendChild(right);
        byPrayer.appendChild(card);

        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ["اول‌وقت","مطلوب","دیر","خیلی دیر"],
            datasets: [{
              data: [onTime, good, late, vlate],
              backgroundColor: ['#22c55e','#f59e0b','#f97316','#ef4444'],
            }]
          },
          options: {
            responsive: false,
            cutout: '58%',
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 14 } },
              tooltip: { intersect:false }
            }
          }
        });
        pieCharts.push(chart);
      });
    }

    // =============================
    // شروع
    // =============================
    function init(){ showView("days"); renderMonth(); refreshReport(); }
    renderMonth = renderMonth; // keep reference (no-op)
    init();
  </script>
</body>
</html>
